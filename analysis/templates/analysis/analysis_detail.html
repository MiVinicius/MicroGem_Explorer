{% extends 'analysis/base.html' %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h2>Relatório de Análise #{{ analysis.id }}</h2>
            <span class="text-muted">{{ analysis.created_at|date:"d M, Y H:i" }}</span>
        </div>
        <div class="btn-group">
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Home</a>
            <a href="{% url 'analysis_list' %}" class="btn btn-outline-secondary">Lista</a>
            <a href="{% url 'analysis_create' %}" class="btn btn-primary">Nova</a>
            <a href="{% url 'analysis_delete' analysis.pk %}" class="btn btn-danger">Excluir</a>
        </div>
    </div>
</div>

<!-- QC Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small">Total de Variantes</h6>
                <h2 class="display-4 fw-bold text-primary">{{ analysis.metrics.total_variants }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small">Razão Ti/Tv</h6>
                <h2 class="display-4 fw-bold text-info">{{ analysis.metrics.ti_tv_ratio }}</h2>
                <small class="text-muted">Ti: {{ analysis.metrics.transitions }} | Tv: {{ analysis.metrics.transversions }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small">Qualidade Média</h6>
                <h2 class="display-4 fw-bold text-success">{{ analysis.metrics.mean_quality }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small">Baixa Qualidade</h6>
                <h2 class="display-4 fw-bold text-danger">{{ analysis.metrics.low_quality_count }}</h2>
                <small class="text-muted">QUAL < 20</small>
            </div>
        </div>
    </div>
</div>

<!-- IGV.js Container -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">Visualizador de Genoma (IGV.js)</div>
            <div class="card-body">
                <div id="igv-div"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/igv@2.15.5/dist/igv.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var igvDiv = document.getElementById("igv-div");
        var options = {
            locus: "all",
            tracks: [
                {
                    name: "Variantes",
                    url: "{{ analysis.vcf_file.url }}",
                    format: "vcf",
                    type: "variant",
                    indexed: false 
                }
            ]
        };

        {% if analysis.reference_file %}
            options.reference = {
                "id": "custom_ref",
                "fastaURL": "{{ analysis.reference_file.url }}",
                "indexURL": null, // Assumindo que não há index separado por enquanto
                "indexed": false
            };
        {% else %}
            options.genome = "ecoli";
        {% endif %}

        igv.createBrowser(igvDiv, options)
            .then(function(browser) {
                console.log("IGV created");
            });
    });
</script>

<!-- Plots -->
<!-- Plots -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header bg-white">Distribuição da Pontuação de Qualidade</div>
            <div class="card-body text-center">
                <div id="qualityPlot"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header bg-white">Densidade de Mutação (Janela: {{ analysis.window_size }}bp)</div>
            <div class="card-body text-center">
                <div id="densityPlot"></div>
            </div>
        </div>
    </div>
</div>

<!-- Variants Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">Tabela de Variantes</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="variantsTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Cromossomo</th>
                                <th>Posição</th>
                                <th>Ref</th>
                                <th>Alt</th>
                                <th>Qual</th>
                                <th>Filtro</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Annotations -->
{% if analysis.metrics.annotations %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span>Anotações de Variantes (Top 50)</span>
                {% if analysis.annotation_file %}
                    <a href="{{ MEDIA_URL }}{{ analysis.annotation_file }}" class="btn btn-sm btn-outline-success" download>Baixar CSV</a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th class="ps-3">Posição</th>
                            <th>Alteração</th>
                            <th>Gene(s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ann in analysis.metrics.annotations %}
                        <tr>
                            <td class="ps-3">{{ ann.CHROM }}:{{ ann.POS }}</td>
                            <td>{{ ann.REF }} &rarr; {{ ann.ALT }}</td>
                            <td>{{ ann.GENES }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        // DataTables
        $('#variantsTable').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "{% url 'analysis_variants_api' analysis.pk %}",
            "columns": [
                { "data": "chrom" },
                { "data": "pos" },
                { "data": "ref" },
                { "data": "alt" },
                { "data": "qual" },
                { "data": "filter" },
                { "data": "info" }
            ],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
            }
        });

        // Plotly - Quality Distribution
        var qualityData = {{ plot_data_quality|safe }};
        if (qualityData && qualityData.length > 0) {
            var trace = {
                x: qualityData,
                type: 'histogram',
                marker: { color: '#198754' }
            };
            var layout = {
                title: 'Distribuição de Qualidade',
                xaxis: { title: 'Pontuação Phred' },
                yaxis: { title: 'Contagem' },
                autosize: true
            };
            Plotly.newPlot('qualityPlot', [trace], layout, {responsive: true});
        } else {
            document.getElementById('qualityPlot').innerHTML = '<p class="text-muted">Sem dados para gráfico</p>';
        }

        // Plotly - Density
        var densityData = {{ plot_data_density|safe }};
        if (densityData && Object.keys(densityData).length > 0) {
            var traces = [];
            for (var chrom in densityData) {
                traces.push({
                    x: densityData[chrom].x,
                    y: densityData[chrom].y,
                    mode: 'lines+markers',
                    name: chrom
                });
            }
            var layout = {
                title: 'Densidade de Mutação',
                xaxis: { title: 'Posição Genômica (bp)' },
                yaxis: { title: 'Contagem' },
                autosize: true
            };
            Plotly.newPlot('densityPlot', traces, layout, {responsive: true});
        } else {
            document.getElementById('densityPlot').innerHTML = '<p class="text-muted">Sem dados para gráfico</p>';
        }
    });
</script>
{% endblock %}
